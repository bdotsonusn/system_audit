name: CI

on:
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "dev" ]

jobs:
  lint_and_validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dev deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Lint (flake8)
        run: flake8 .

      - name: Style check (black)
        run: black --check .

      - name: Import order (isort)
        run: isort --check-only .

      - name: Validate sample JSON against schema
        run: |
          python - << 'PY'
          import json, sys
          from jsonschema import validate, Draft202012Validator
          schema = json.load(open("schemas/system_audit.schema.json", encoding="utf-8"))
          data = json.load(open("system_audit_report_v3.json", encoding="utf-8"))
          Draft202012Validator.check_schema(schema)
          validate(data, schema)
          print("? JSON matches schema.")
          PY

  # (optional) prove the script runs on Windows later
  run_audit_script:
    needs: lint_and_validate
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install runtime deps
        run: |
          python -m pip install --upgrade pip
          pip install psutil pandas openpyxl colorama
      - name: Dry-run audit script
        shell: pwsh
        run: |
          if (Test-Path .\neo_system_audit_v3.py) {
            python .\neo_system_audit_v3.py
          } else {
            Write-Host "neo_system_audit_v3.py not present; skipping"
          }
